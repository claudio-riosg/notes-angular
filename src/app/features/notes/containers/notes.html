<div class="notes-page">
  <header class="notes-header">
    <div class="notes-header__top">
      <h1 class="notes-header__title">My Notes</h1>
      <div class="notes-header__actions">
        <button 
          type="button"
          class="btn btn--primary btn--md"
          (click)="onCreateNote()"
          [disabled]="noteOrchestrator.isCreating()"
          [attr.aria-busy]="noteOrchestrator.isCreating()">
          ‚úèÔ∏è New Note
        </button>
      </div>
    </div>
    
    <div class="notes-header__filters">
      <search-bar
        [searchTerm]="noteOrchestrator.filter().searchTerm"
        (searchChange)="onSearchChange($event)"
        (clear)="onSearchClear()">
      </search-bar>
      
      <div class="notes-header__filter-controls">
        <button 
          type="button"
          [class]="'btn btn--sm ' + (noteOrchestrator.filter().showPinnedOnly ? 'btn--primary' : 'btn--secondary')"
          (click)="onTogglePinnedFilter()">
          üìå Pinned Only
        </button>
        
        @if (noteOrchestrator.hasActiveFilters()) {
          <button 
            type="button"
            class="btn btn--ghost btn--sm"
            (click)="onClearFilters()">
            Clear Filters
          </button>
        }
      </div>
    </div>

    <!-- Stats -->
    @if (noteOrchestrator.totalNotesCount() > 0) {
      <div class="notes-stats">
        <span class="notes-stats__item">
          Total: {{ noteOrchestrator.totalNotesCount() }}
        </span>
        @if (noteOrchestrator.filter().searchTerm || noteOrchestrator.hasActiveFilters()) {
          <span class="notes-stats__item">
            Showing: {{ noteOrchestrator.filteredNotes().length }}
          </span>
        }
      </div>
    }
  </header>

  <!-- Tag Filter -->
  @if (noteOrchestrator.allTags().length > 0) {
    <aside class="notes-sidebar">
      <tag-filter
        [availableTags]="noteOrchestrator.allTags()"
        [selectedTags]="noteOrchestrator.filter().selectedTags"
        (tagToggle)="onTagToggle($event)"
        (clearTags)="onClearTagFilters()">
      </tag-filter>
    </aside>
  }

  <!-- Loading State -->
  @if (noteOrchestrator.isLoading()) {
    <div class="notes-loading">
      <div class="notes-loading__spinner"></div>
      <p>Loading notes...</p>
    </div>
  }

  <!-- Error State -->
  @if (noteOrchestrator.error()) {
    <div class="notes-error">
      <p>{{ noteOrchestrator.error() }}</p>
      <button 
        type="button"
        class="btn btn--danger btn--sm"
        (click)="onRetry()">
        Retry
      </button>
    </div>
  }

  <!-- Notes Grid -->
  @if (!noteOrchestrator.isLoading() && !noteOrchestrator.error()) {
    <main class="notes-content">
      @defer (on viewport) {
        <notes-grid
          [pinnedNotes]="noteOrchestrator.pinnedNotes()"
          [unpinnedNotes]="noteOrchestrator.unpinnedNotes()"
          [emptyTitle]="getEmptyTitle()"
          [emptyMessage]="getEmptyMessage()"
          [showCreateButton]="!noteOrchestrator.hasActiveFilters()"
          (noteClick)="onNoteClick($event)"
          (togglePin)="onTogglePin($event)"
          (menuClick)="onMenuClick($event)"
          (tagClick)="onTagClick($event)"
          (createNote)="onCreateNote()">
        </notes-grid>
      } @placeholder {
        <div class="notes-loading">
          <div class="notes-loading__spinner"></div>
          <p>Loading notes...</p>
        </div>
      } @loading {
        <div class="notes-loading">
          <div class="notes-loading__spinner"></div>
          <p>Preparing notes grid...</p>
        </div>
      }
    </main>
  }

  <!-- Note Modal -->
  <note-modal
    [isOpen]="modalOpen()"
    [note]="noteForEdit()"
    [availableTags]="noteOrchestrator.allTags()"
    [isSubmitting]="isSubmitting()"
    (close)="onCloseModal()"
    (submit)="onModalSubmit($event)">
  </note-modal>

  <!-- Context Menu -->
  <note-context-menu
    [isVisible]="contextMenuOpen()"
    [note]="contextMenuNote()"
    [position]="contextMenuPosition()"
    (edit)="onEditFromMenu($event)"
    (togglePin)="onTogglePin($event.id)"
    (duplicate)="onDuplicateNote($event)"
    (delete)="onDeleteNote($event)"
    (close)="onCloseContextMenu()">
  </note-context-menu>
</div>